{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","events","Stream","unzip","Sax","tmp","utils","FlowControl","StyleManager","WorkbookPropertiesManager","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","module","exports","options","styles","init","properties","worksheetReaders","hyperlinkReaders","readers","atEnd","waitingWorkSheets","tempFileCleanupCallbacks","inherits","EventEmitter","_getStream","input","Readable","createReadStream","Error","flowControl","_flowControl","entries","sharedStrings","hyperlinks","worksheets","read","stream","zip","Parse","on","entry","match","sheetNo","path","autodrain","_parseWorkbook","_parseSharedStrings","_parseStyles","_parseWorksheet","file","err","fd","cleanupCallback","tempStream","createWriteStream","push","pipe","_parseHyperlinks","length","currentBook","processBooks","worksheetInfo","worksheet","node","forEach","cb","emit","setImmediate","_emitEntry","payload","type","parseStream","self","parser","createStream","inT","t","index","name","text","error","_getReader","Type","collection","reader","id","worksheetReader","hyperlinksReader"],"mappings":"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","sourcesContent":["'use strict';\n\nconst fs = require('fs');\nconst events = require('events');\nconst Stream = require('stream');\nconst unzip = require('unzipper');\nconst Sax = require('sax');\nconst tmp = require('tmp');\n\nconst utils = require('../../utils/utils');\nconst FlowControl = require('../../utils/flow-control');\n\nconst StyleManager = require('../../xlsx/xform/style/styles-xform');\nconst WorkbookPropertiesManager = require('../../xlsx/xform/book/workbook-properties-xform');\n\nconst WorksheetReader = require('./worksheet-reader');\nconst HyperlinkReader = require('./hyperlink-reader');\n\ntmp.setGracefulCleanup();\n\nconst WorkbookReader = (module.exports = function(options) {\n  this.options = options = options || {};\n\n  this.styles = new StyleManager();\n  this.styles.init();\n\n  this.properties = new WorkbookPropertiesManager();\n\n  // worksheet readers, indexed by sheetNo\n  this.worksheetReaders = {};\n\n  // hyperlink readers, indexed by sheetNo\n  this.hyperlinkReaders = {};\n\n  // count the open readers\n  this.readers = 0;\n\n  // end of stream check\n  this.atEnd = false;\n\n  // worksheets, deferred for parsing after shared strings reading\n  this.waitingWorkSheets = [];\n\n  // callbacks for temp files cleanup\n  this.tempFileCleanupCallbacks = [];\n});\n\nutils.inherits(WorkbookReader, events.EventEmitter, {\n  _getStream(input) {\n    if (input instanceof Stream.Readable) {\n      return input;\n    }\n    if (typeof input === 'string') {\n      return fs.createReadStream(input);\n    }\n    throw new Error('Could not recognise input');\n  },\n\n  get flowControl() {\n    if (!this._flowControl) {\n      this._flowControl = new FlowControl(this.options);\n    }\n    return this._flowControl;\n  },\n\n  options: {\n    entries: ['emit'],\n    sharedStrings: ['cache', 'emit'],\n    styles: ['cache'],\n    hyperlinks: ['cache', 'emit'],\n    worksheets: ['emit'],\n  },\n  read(input, options) {\n    const stream = (this.stream = this._getStream(input));\n    const zip = (this.zip = unzip.Parse());\n\n    zip.on('entry', entry => {\n      let match;\n      let sheetNo;\n      // console.log(entry.path);\n      switch (entry.path) {\n        case '_rels/.rels':\n        case 'xl/_rels/workbook.xml.rels':\n          entry.autodrain();\n          break;\n        case 'xl/workbook.xml':\n          this._parseWorkbook(entry, options);\n          break;\n        case 'xl/sharedStrings.xml':\n          this._parseSharedStrings(entry, options);\n          break;\n        case 'xl/styles.xml':\n          this._parseStyles(entry, options);\n          break;\n        default:\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\n            sheetNo = match[1];\n            if (this.sharedStrings) {\n              this._parseWorksheet(entry, sheetNo, options);\n            } else {\n              // create temp file for each worksheet\n              tmp.file((err, path, fd, cleanupCallback) => {\n                if (err) throw err;\n\n                const tempStream = fs.createWriteStream(path);\n\n                this.waitingWorkSheets.push({ sheetNo, options, path });\n                entry.pipe(tempStream);\n\n                this.tempFileCleanupCallbacks.push(cleanupCallback);\n              });\n            }\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\n            sheetNo = match[1];\n            this._parseHyperlinks(entry, sheetNo, options);\n          } else {\n            entry.autodrain();\n          }\n          break;\n      }\n    });\n\n    zip.on('close', () => {\n      if (this.waitingWorkSheets.length) {\n        let currentBook = 0;\n\n        var processBooks = () => {\n          const worksheetInfo = this.waitingWorkSheets[currentBook];\n          const entry = fs.createReadStream(worksheetInfo.path);\n\n          const sheetNo = worksheetInfo.sheetNo;\n          const options = worksheetInfo.options;\n          const worksheet = this._parseWorksheet(entry, sheetNo, options);\n\n          worksheet.on('finished', node => {\n            ++currentBook;\n            if (currentBook === this.waitingWorkSheets.length) {\n              // temp files cleaning up\n              this.tempFileCleanupCallbacks.forEach(cb => {\n                cb();\n              });\n\n              this.tempFileCleanupCallbacks = [];\n\n              this.emit('end');\n              this.atEnd = true;\n              if (!this.readers) {\n                this.emit('finished');\n              }\n            } else {\n              setImmediate(processBooks);\n            }\n          });\n        };\n        setImmediate(processBooks);\n      } else {\n        this.emit('end');\n        this.atEnd = true;\n        if (!this.readers) {\n          this.emit('finished');\n        }\n      }\n    });\n\n    zip.on('error', err => {\n      this.emit('error', err);\n    });\n\n    // Pipe stream into top flow-control\n    // this.flowControl.pipe(zip);\n    stream.pipe(zip);\n  },\n  _emitEntry(options, payload) {\n    if (options.entries === 'emit') {\n      this.emit('entry', payload);\n    }\n  },\n  _parseWorkbook(entry, options) {\n    this._emitEntry(options, { type: 'workbook' });\n    this.properties.parseStream(entry);\n  },\n  _parseSharedStrings(entry, options) {\n    this._emitEntry(options, { type: 'shared-strings' });\n    const self = this;\n    let sharedStrings = null;\n    switch (options.sharedStrings) {\n      case 'cache':\n        sharedStrings = this.sharedStrings = [];\n        break;\n      case 'emit':\n        break;\n      default:\n        entry.autodrain();\n        return;\n    }\n\n    const parser = Sax.createStream(true, {});\n    let inT = false;\n    let t = null;\n    let index = 0;\n    parser.on('opentag', node => {\n      if (node.name === 't') {\n        t = null;\n        inT = true;\n      }\n    });\n    parser.on('closetag', name => {\n      if (inT && name === 't') {\n        if (sharedStrings) {\n          sharedStrings.push(t);\n        } else {\n          self.emit('shared-string', { index: index++, text: t });\n        }\n        t = null;\n      }\n    });\n    parser.on('text', text => {\n      t = t ? t + text : text;\n    });\n    parser.on('error', error => {\n      self.emit('error', error);\n    });\n    entry.pipe(parser);\n  },\n  _parseStyles(entry, options) {\n    this._emitEntry(options, { type: 'styles' });\n    if (options.styles !== 'cache') {\n      entry.autodrain();\n      return;\n    }\n    this.styles = new StyleManager();\n    this.styles.parseStream(entry);\n  },\n  _getReader(Type, collection, sheetNo) {\n    const self = this;\n    let reader = collection[sheetNo];\n    if (!reader) {\n      reader = new Type(this, sheetNo);\n      self.readers++;\n      reader.on('finished', () => {\n        if (!--self.readers) {\n          if (self.atEnd) {\n            self.emit('finished');\n          }\n        }\n      });\n      collection[sheetNo] = reader;\n    }\n    return reader;\n  },\n  _parseWorksheet(entry, sheetNo, options) {\n    this._emitEntry(options, { type: 'worksheet', id: sheetNo });\n    const worksheetReader = this._getReader(WorksheetReader, this.worksheetReaders, sheetNo);\n    if (options.worksheets === 'emit') {\n      this.emit('worksheet', worksheetReader);\n    }\n    worksheetReader.read(entry, options, this.hyperlinkReaders[sheetNo]);\n    return worksheetReader;\n  },\n  _parseHyperlinks(entry, sheetNo, options) {\n    this._emitEntry(options, { type: 'hyerlinks', id: sheetNo });\n    const hyperlinksReader = this._getReader(HyperlinkReader, this.hyperlinkReaders, sheetNo);\n    if (options.hyperlinks === 'emit') {\n      this.emit('hyperlinks', hyperlinksReader);\n    }\n    hyperlinksReader.read(entry, options);\n  },\n});\n"],"file":"workbook-reader.js"}